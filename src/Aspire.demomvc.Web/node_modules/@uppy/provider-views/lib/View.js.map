{"version":3,"names":["getFileType","isPreviewSupported","remoteFileObjToLocal","View","constructor","plugin","opts","filterItems","items","state","getPluginState","filterInput","filter","folder","name","toLowerCase","indexOf","recordShiftKeyPress","e","isShiftKeyPressed","shiftKey","isChecked","file","currentSelection","some","item","id","provider","isHandlingScroll","preFirstRender","bind","handleError","clearSelection","cancelPicking","setPluginState","didFirstRender","onFirstRender","shouldHandleScroll","event","scrollHeight","scrollTop","offsetHeight","target","scrollPosition","dashboard","uppy","getPlugin","hideAllPanels","error","_error$cause","message","i18n","log","toString","isAuthError","cause","info","details","registerRequestClient","requestClientId","getTagFile","tagFile","source","type","mimeType","isRemote","data","meta","body","fileId","remote","companionUrl","url","fileUrl","requestPath","providerName","fileType","preview","thumbnail","author","authorName","String","authorUrl","relDirPath","relativePath","absDirPath","absolutePath","toggleCheckbox","stopPropagation","preventDefault","currentTarget","focus","folders","files","concat","lastCheckbox","prevIndex","currentIndex","newSelection","slice","reducedNewSelection","restrictionError","validateRestrictions","getFiles","push","infoTimeout","Set","setLoading","loading"],"sources":["View.ts"],"sourcesContent":["import type {\n  UnknownProviderPlugin,\n  UnknownSearchProviderPlugin,\n} from '@uppy/core/lib/Uppy'\nimport type { Body, Meta, TagFile } from '@uppy/utils/lib/UppyFile'\nimport type { CompanionFile } from '@uppy/utils/lib/CompanionFile'\nimport getFileType from '@uppy/utils/lib/getFileType'\nimport isPreviewSupported from '@uppy/utils/lib/isPreviewSupported'\nimport remoteFileObjToLocal from '@uppy/utils/lib/remoteFileObjToLocal'\n\ntype PluginType = 'Provider' | 'SearchProvider'\n\n// Conditional type for selecting the plugin\ntype SelectedPlugin<M extends Meta, B extends Body, T extends PluginType> =\n  T extends 'Provider' ? UnknownProviderPlugin<M, B>\n  : T extends 'SearchProvider' ? UnknownSearchProviderPlugin<M, B>\n  : never\n\n// Conditional type for selecting the provider from the selected plugin\ntype SelectedProvider<\n  M extends Meta,\n  B extends Body,\n  T extends PluginType,\n> = SelectedPlugin<M, B, T>['provider']\n\nexport interface ViewOptions<\n  M extends Meta,\n  B extends Body,\n  T extends PluginType,\n> {\n  provider: SelectedProvider<M, B, T>\n  viewType?: string\n  showTitles?: boolean\n  showFilter?: boolean\n  showBreadcrumbs?: boolean\n  loadAllFiles?: boolean\n}\n\nexport default class View<\n  M extends Meta,\n  B extends Body,\n  T extends PluginType,\n  O extends ViewOptions<M, B, T>,\n> {\n  plugin: SelectedPlugin<M, B, T>\n\n  provider: SelectedProvider<M, B, T>\n\n  isHandlingScroll: boolean\n\n  requestClientId: string\n\n  isShiftKeyPressed: boolean\n\n  lastCheckbox: CompanionFile | undefined\n\n  protected opts: O\n\n  constructor(plugin: SelectedPlugin<M, B, T>, opts: O) {\n    this.plugin = plugin\n    this.provider = opts.provider\n    this.opts = opts\n\n    this.isHandlingScroll = false\n\n    this.preFirstRender = this.preFirstRender.bind(this)\n    this.handleError = this.handleError.bind(this)\n    this.clearSelection = this.clearSelection.bind(this)\n    this.cancelPicking = this.cancelPicking.bind(this)\n  }\n\n  preFirstRender(): void {\n    this.plugin.setPluginState({ didFirstRender: true })\n    this.plugin.onFirstRender()\n  }\n\n  shouldHandleScroll(event: Event): boolean {\n    const { scrollHeight, scrollTop, offsetHeight } =\n      event.target as HTMLElement\n    const scrollPosition = scrollHeight - (scrollTop + offsetHeight)\n\n    return scrollPosition < 50 && !this.isHandlingScroll\n  }\n\n  clearSelection(): void {\n    this.plugin.setPluginState({ currentSelection: [], filterInput: '' })\n  }\n\n  cancelPicking(): void {\n    this.clearSelection()\n\n    const dashboard = this.plugin.uppy.getPlugin('Dashboard')\n\n    if (dashboard) {\n      // @ts-expect-error impossible to type this correctly without adding dashboard\n      // as a dependency to this package.\n      dashboard.hideAllPanels()\n    }\n  }\n\n  handleError(error: Error): void {\n    const { uppy } = this.plugin\n    const message = uppy.i18n('companionError')\n\n    uppy.log(error.toString())\n\n    if (\n      (error as any).isAuthError ||\n      (error.cause as Error)?.name === 'AbortError'\n    ) {\n      // authError just means we're not authenticated, don't show to user\n      // AbortError means the user has clicked \"cancel\" on an operation\n      return\n    }\n\n    uppy.info({ message, details: error.toString() }, 'error', 5000)\n  }\n\n  registerRequestClient(): void {\n    this.requestClientId = this.provider.provider\n    this.plugin.uppy.registerRequestClient(this.requestClientId, this.provider)\n  }\n\n  // TODO: document what is a \"tagFile\" or get rid of this concept\n  getTagFile(file: CompanionFile): TagFile<M> {\n    const tagFile: TagFile<M> = {\n      id: file.id,\n      source: this.plugin.id,\n      name: file.name || file.id,\n      type: file.mimeType,\n      isRemote: true,\n      data: file,\n      // @ts-expect-error meta is filled conditionally below\n      meta: {},\n      body: {\n        fileId: file.id,\n      },\n      remote: {\n        companionUrl: this.plugin.opts.companionUrl,\n        // @ts-expect-error untyped for now\n        url: `${this.provider.fileUrl(file.requestPath)}`,\n        body: {\n          fileId: file.id,\n        },\n        providerName: this.provider.name,\n        provider: this.provider.provider,\n        requestClientId: this.requestClientId,\n      },\n    }\n\n    const fileType = getFileType(tagFile)\n\n    // TODO Should we just always use the thumbnail URL if it exists?\n    if (fileType && isPreviewSupported(fileType)) {\n      tagFile.preview = file.thumbnail\n    }\n\n    if (file.author) {\n      if (file.author.name != null)\n        tagFile.meta!.authorName = String(file.author.name)\n      if (file.author.url) tagFile.meta!.authorUrl = file.author.url\n    }\n\n    // add relativePath similar to non-remote files: https://github.com/transloadit/uppy/pull/4486#issuecomment-1579203717\n    if (file.relDirPath != null)\n      tagFile.meta!.relativePath =\n        file.relDirPath ? `${file.relDirPath}/${tagFile.name}` : null\n    // and absolutePath (with leading slash) https://github.com/transloadit/uppy/pull/4537#issuecomment-1614236655\n    if (file.absDirPath != null)\n      tagFile.meta!.absolutePath =\n        file.absDirPath ?\n          `/${file.absDirPath}/${tagFile.name}`\n        : `/${tagFile.name}`\n\n    return tagFile\n  }\n\n  filterItems = (items: CompanionFile[]): CompanionFile[] => {\n    const state = this.plugin.getPluginState()\n    if (!state.filterInput || state.filterInput === '') {\n      return items\n    }\n    return items.filter((folder) => {\n      return (\n        folder.name.toLowerCase().indexOf(state.filterInput.toLowerCase()) !==\n        -1\n      )\n    })\n  }\n\n  recordShiftKeyPress = (e: KeyboardEvent | MouseEvent): void => {\n    this.isShiftKeyPressed = e.shiftKey\n  }\n\n  /**\n   * Toggles file/folder checkbox to on/off state while updating files list.\n   *\n   * Note that some extra complexity comes from supporting shift+click to\n   * toggle multiple checkboxes at once, which is done by getting all files\n   * in between last checked file and current one.\n   */\n  toggleCheckbox(e: Event, file: CompanionFile): void {\n    e.stopPropagation()\n    e.preventDefault()\n    ;(e.currentTarget as HTMLInputElement).focus()\n    const { folders, files } = this.plugin.getPluginState()\n    const items = this.filterItems(folders.concat(files))\n    // Shift-clicking selects a single consecutive list of items\n    // starting at the previous click.\n    if (this.lastCheckbox && this.isShiftKeyPressed) {\n      const { currentSelection } = this.plugin.getPluginState()\n      const prevIndex = items.indexOf(this.lastCheckbox)\n      const currentIndex = items.indexOf(file)\n      const newSelection =\n        prevIndex < currentIndex ?\n          items.slice(prevIndex, currentIndex + 1)\n        : items.slice(currentIndex, prevIndex + 1)\n      const reducedNewSelection: CompanionFile[] = []\n\n      // Check restrictions on each file in currentSelection,\n      // reduce it to only contain files that pass restrictions\n      for (const item of newSelection) {\n        const { uppy } = this.plugin\n        const restrictionError = uppy.validateRestrictions(\n          remoteFileObjToLocal(item),\n          [...uppy.getFiles(), ...reducedNewSelection],\n        )\n\n        if (!restrictionError) {\n          reducedNewSelection.push(item)\n        } else {\n          uppy.info(\n            { message: restrictionError.message },\n            'error',\n            uppy.opts.infoTimeout,\n          )\n        }\n      }\n      this.plugin.setPluginState({\n        currentSelection: [\n          ...new Set([...currentSelection, ...reducedNewSelection]),\n        ],\n      })\n      return\n    }\n\n    this.lastCheckbox = file\n    const { currentSelection } = this.plugin.getPluginState()\n    if (this.isChecked(file)) {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.filter(\n          (item) => item.id !== file.id,\n        ),\n      })\n    } else {\n      this.plugin.setPluginState({\n        currentSelection: currentSelection.concat([file]),\n      })\n    }\n  }\n\n  isChecked = (file: CompanionFile): boolean => {\n    const { currentSelection } = this.plugin.getPluginState()\n    // comparing id instead of the file object, because the reference to the object\n    // changes when we switch folders, and the file list is updated\n    return currentSelection.some((item) => item.id === file.id)\n  }\n\n  setLoading(loading: boolean | string): void {\n    this.plugin.setPluginState({ loading })\n  }\n}\n"],"mappings":"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"}