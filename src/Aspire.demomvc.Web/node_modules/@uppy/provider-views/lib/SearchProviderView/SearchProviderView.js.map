{"version":3,"names":["h","SearchFilterInput","Browser","CloseWrapper","View","packageJson","defaultState","isInputMode","files","folders","breadcrumbs","filterInput","currentSelection","searchTerm","defaultOptions","viewType","showTitles","showFilter","showBreadcrumbs","_updateFilesAndInputMode","_classPrivateFieldLooseKey","SearchProviderView","constructor","plugin","opts","Object","defineProperty","value","_updateFilesAndInputMode2","nextPageQuery","search","bind","clearSearch","resetPluginState","handleScroll","donePicking","render","setPluginState","registerRequestClient","tearDown","query","getPluginState","setLoading","res","provider","_classPrivateFieldLooseBase","err","handleError","event","shouldHandleScroll","isHandlingScroll","response","error","uppy","log","addFiles","map","file","getTagFile","state","viewOptions","_this","didFirstRender","i18n","preFirstRender","targetViewOptions","loading","isChecked","filterItems","recordShiftKeyPress","hasInput","browserProps","toggleCheckbox","done","cancel","cancelPicking","showSearchFilter","searchOnInput","searchInputLabel","clearSearchLabel","noResultsLabel","title","isLoading","pluginIcon","icon","uppyFiles","getFiles","validateRestrictions","arguments","onUnmount","className","inputLabel","buttonLabel","inputClassName","buttonCSSClassName","showButton","items","forEach","item","push","searchedFor","VERSION","version"],"sources":["SearchProviderView.tsx"],"sourcesContent":["import { h } from 'preact'\n\nimport type { Body, Meta } from '@uppy/utils/lib/UppyFile'\nimport type { UnknownSearchProviderPlugin } from '@uppy/core/lib/Uppy'\nimport type { DefinePluginOpts } from '@uppy/core/lib/BasePlugin'\nimport type Uppy from '@uppy/core'\nimport type { CompanionFile } from '@uppy/utils/lib/CompanionFile'\nimport SearchFilterInput from '../SearchFilterInput.tsx'\nimport Browser from '../Browser.tsx'\nimport CloseWrapper from '../CloseWrapper.ts'\nimport View, { type ViewOptions } from '../View.ts'\n\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../../package.json'\n\nconst defaultState = {\n  isInputMode: true,\n  files: [],\n  folders: [],\n  breadcrumbs: [],\n  filterInput: '',\n  currentSelection: [],\n  searchTerm: null,\n}\n\ntype PluginType = 'SearchProvider'\n\nconst defaultOptions = {\n  viewType: 'grid',\n  showTitles: true,\n  showFilter: true,\n  showBreadcrumbs: true,\n}\n\ntype Opts<\n  M extends Meta,\n  B extends Body,\n  T extends PluginType,\n> = DefinePluginOpts<ViewOptions<M, B, T>, keyof typeof defaultOptions>\n\ntype Res = {\n  items: CompanionFile[]\n  nextPageQuery: string | null\n  searchedFor: string\n}\n\n/**\n * SearchProviderView, used for Unsplash and future image search providers.\n * Extends generic View, shared with regular providers like Google Drive and Instagram.\n */\nexport default class SearchProviderView<\n  M extends Meta,\n  B extends Body,\n> extends View<M, B, PluginType, Opts<M, B, PluginType>> {\n  static VERSION = packageJson.version\n\n  nextPageQuery: string | null = null\n\n  constructor(\n    plugin: UnknownSearchProviderPlugin<M, B>,\n    opts: ViewOptions<M, B, PluginType>,\n  ) {\n    super(plugin, { ...defaultOptions, ...opts })\n\n    this.search = this.search.bind(this)\n    this.clearSearch = this.clearSearch.bind(this)\n    this.resetPluginState = this.resetPluginState.bind(this)\n    this.handleScroll = this.handleScroll.bind(this)\n    this.donePicking = this.donePicking.bind(this)\n\n    this.render = this.render.bind(this)\n\n    this.plugin.setPluginState(defaultState)\n\n    this.registerRequestClient()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  tearDown(): void {\n    // Nothing.\n  }\n\n  resetPluginState(): void {\n    this.plugin.setPluginState(defaultState)\n  }\n\n  #updateFilesAndInputMode(res: Res, files: CompanionFile[]): void {\n    this.nextPageQuery = res.nextPageQuery\n    res.items.forEach((item) => {\n      files.push(item)\n    })\n    this.plugin.setPluginState({\n      currentSelection: [],\n      isInputMode: false,\n      files,\n      searchTerm: res.searchedFor,\n    })\n  }\n\n  async search(query: string): Promise<void> {\n    const { searchTerm } = this.plugin.getPluginState()\n    if (query && query === searchTerm) {\n      // no need to search again as this is the same as the previous search\n      return\n    }\n\n    this.setLoading(true)\n    try {\n      const res = await this.provider.search<Res>(query)\n      this.#updateFilesAndInputMode(res, [])\n    } catch (err) {\n      this.handleError(err)\n    } finally {\n      this.setLoading(false)\n    }\n  }\n\n  clearSearch(): void {\n    this.plugin.setPluginState({\n      currentSelection: [],\n      files: [],\n      searchTerm: null,\n    })\n  }\n\n  async handleScroll(event: Event): Promise<void> {\n    const query = this.nextPageQuery || null\n\n    if (this.shouldHandleScroll(event) && query) {\n      this.isHandlingScroll = true\n\n      try {\n        const { files, searchTerm } = this.plugin.getPluginState()\n        const response = await this.provider.search<Res>(searchTerm!, query)\n\n        this.#updateFilesAndInputMode(response, files)\n      } catch (error) {\n        this.handleError(error)\n      } finally {\n        this.isHandlingScroll = false\n      }\n    }\n  }\n\n  donePicking(): void {\n    const { currentSelection } = this.plugin.getPluginState()\n    this.plugin.uppy.log('Adding remote search provider files')\n    this.plugin.uppy.addFiles(\n      currentSelection.map((file) => this.getTagFile(file)),\n    )\n    this.resetPluginState()\n  }\n\n  render(\n    state: unknown,\n    viewOptions: Omit<ViewOptions<M, B, PluginType>, 'provider'> = {},\n  ) {\n    const { didFirstRender, isInputMode, searchTerm } =\n      this.plugin.getPluginState()\n    const { i18n } = this.plugin.uppy\n\n    if (!didFirstRender) {\n      this.preFirstRender()\n    }\n\n    const targetViewOptions = { ...this.opts, ...viewOptions }\n    const { files, folders, filterInput, loading, currentSelection } =\n      this.plugin.getPluginState()\n    const { isChecked, filterItems, recordShiftKeyPress } = this\n    const hasInput = filterInput !== ''\n\n    const browserProps = {\n      isChecked,\n      toggleCheckbox: this.toggleCheckbox.bind(this),\n      recordShiftKeyPress,\n      currentSelection,\n      files: hasInput ? filterItems(files) : files,\n      folders: hasInput ? filterItems(folders) : folders,\n      handleScroll: this.handleScroll,\n      done: this.donePicking,\n      cancel: this.cancelPicking,\n\n      // For SearchFilterInput component\n      showSearchFilter: targetViewOptions.showFilter,\n      search: this.search,\n      clearSearch: this.clearSearch,\n      searchTerm,\n      searchOnInput: false,\n      searchInputLabel: i18n('search'),\n      clearSearchLabel: i18n('resetSearch'),\n\n      noResultsLabel: i18n('noSearchResults'),\n      title: this.plugin.title,\n      viewType: targetViewOptions.viewType,\n      showTitles: targetViewOptions.showTitles,\n      showFilter: targetViewOptions.showFilter,\n      isLoading: loading,\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      pluginIcon: this.plugin.icon,\n      i18n,\n      uppyFiles: this.plugin.uppy.getFiles(),\n      validateRestrictions: (\n        ...args: Parameters<Uppy<M, B>['validateRestrictions']>\n      ) => this.plugin.uppy.validateRestrictions(...args),\n    }\n\n    if (isInputMode) {\n      return (\n        <CloseWrapper onUnmount={this.resetPluginState}>\n          <div className=\"uppy-SearchProvider\">\n            <SearchFilterInput\n              search={this.search}\n              inputLabel={i18n('enterTextToSearch')}\n              buttonLabel={i18n('searchImages')}\n              inputClassName=\"uppy-c-textInput uppy-SearchProvider-input\"\n              buttonCSSClassName=\"uppy-SearchProvider-searchButton\"\n              showButton\n            />\n          </div>\n        </CloseWrapper>\n      )\n    }\n\n    return (\n      <CloseWrapper onUnmount={this.resetPluginState}>\n        {/* eslint-disable-next-line react/jsx-props-no-spreading */}\n        <Browser {...browserProps} />\n      </CloseWrapper>\n    )\n  }\n}\n"],"mappings":"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"}