{"version":3,"names":["h","UIPlugin","RequestClient","toArray","UrlUI","forEachDroppedOrPastedUrl","packageJson","locale","UrlIcon","focusable","width","height","viewBox","d","fill","addProtocolToURL","url","protocolRegex","defaultProtocol","test","canHandleRootDrop","e","items","dataTransfer","urls","filter","item","kind","type","length","checkIfCorrectURL","startsWith","getFileNameFromUrl","pathname","URL","substring","lastIndexOf","Url","constructor","uppy","opts","getMeta","client","post","then","res","error","log","Error","addFile","protocollessUrl","optionalMeta","info","i18n","undefined","meta","tagFile","source","id","name","data","size","isRemote","body","remote","companionUrl","hostname","fileId","requestClientId","err","isRestriction","message","details","handleRootDrop","handleRootPaste","clipboardData","title","icon","defaultLocale","i18nInit","pluginId","provider","companionHeaders","companionCookiesRule","registerRequestClient","render","install","target","mount","uninstall","unmount","_class","VERSION","version","prototype"],"sources":["Url.tsx"],"sourcesContent":["import { h, type ComponentChild } from 'preact'\nimport { UIPlugin, Uppy } from '@uppy/core'\nimport {\n  RequestClient,\n  type CompanionPluginOptions,\n} from '@uppy/companion-client'\nimport toArray from '@uppy/utils/lib/toArray'\nimport type { TagFile, Meta, Body } from '@uppy/utils/lib/UppyFile'\nimport UrlUI from './UrlUI.tsx'\nimport forEachDroppedOrPastedUrl from './utils/forEachDroppedOrPastedUrl.ts'\n\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\nimport locale from './locale.ts'\n\nfunction UrlIcon() {\n  return (\n    <svg\n      aria-hidden=\"true\"\n      focusable=\"false\"\n      width=\"32\"\n      height=\"32\"\n      viewBox=\"0 0 32 32\"\n    >\n      <path\n        d=\"M23.637 15.312l-2.474 2.464a3.582 3.582 0 01-.577.491c-.907.657-1.897.986-2.968.986a4.925 4.925 0 01-3.959-1.971c-.248-.329-.164-.902.165-1.149.33-.247.907-.164 1.155.164 1.072 1.478 3.133 1.724 4.618.656a.642.642 0 00.33-.328l2.473-2.463c1.238-1.313 1.238-3.366-.082-4.597a3.348 3.348 0 00-4.618 0l-1.402 1.395a.799.799 0 01-1.154 0 .79.79 0 010-1.15l1.402-1.394a4.843 4.843 0 016.843 0c2.062 1.805 2.144 5.007.248 6.896zm-8.081 5.664l-1.402 1.395a3.348 3.348 0 01-4.618 0c-1.319-1.23-1.319-3.365-.082-4.596l2.475-2.464.328-.328c.743-.492 1.567-.739 2.475-.657.906.165 1.648.574 2.143 1.314.248.329.825.411 1.155.165.33-.248.412-.822.165-1.15-.825-1.068-1.98-1.724-3.216-1.888-1.238-.247-2.556.082-3.628.902l-.495.493-2.474 2.464c-1.897 1.969-1.814 5.09.083 6.977.99.904 2.226 1.396 3.463 1.396s2.473-.492 3.463-1.395l1.402-1.396a.79.79 0 000-1.15c-.33-.328-.908-.41-1.237-.082z\"\n        fill=\"#FF753E\"\n        fill-rule=\"nonzero\"\n      />\n    </svg>\n  )\n}\n\nfunction addProtocolToURL(url: string) {\n  const protocolRegex = /^[a-z0-9]+:\\/\\//\n  const defaultProtocol = 'http://'\n  if (protocolRegex.test(url)) {\n    return url\n  }\n\n  return defaultProtocol + url\n}\n\nfunction canHandleRootDrop(e: DragEvent) {\n  const items = toArray(e.dataTransfer!.items)\n  const urls = items.filter(\n    (item) => item.kind === 'string' && item.type === 'text/uri-list',\n  )\n  return urls.length > 0\n}\n\nfunction checkIfCorrectURL(url?: string) {\n  return url?.startsWith('http://') || url?.startsWith('https://')\n}\n\nfunction getFileNameFromUrl(url: string) {\n  const { pathname } = new URL(url)\n  return pathname.substring(pathname.lastIndexOf('/') + 1)\n}\n\n/*\n * Response from the /url/meta Companion endpoint.\n * Has to be kept in sync with `getURLMeta` in `companion/src/server/helpers/request.js`.\n */\ntype MetaResponse = {\n  name: string\n  type: string\n  size: number | null\n  statusCode: number\n}\n\nexport type UrlOptions = CompanionPluginOptions\n\nexport default class Url<M extends Meta, B extends Body> extends UIPlugin<\n  UrlOptions,\n  M,\n  B\n> {\n  static VERSION = packageJson.version\n\n  static requestClientId = Url.name\n\n  icon: () => h.JSX.Element\n\n  hostname: string\n\n  client: RequestClient<M, B>\n\n  canHandleRootDrop: typeof canHandleRootDrop\n\n  constructor(uppy: Uppy<M, B>, opts: UrlOptions) {\n    super(uppy, opts)\n    this.id = this.opts.id || 'Url'\n    this.title = this.opts.title || 'Link'\n    this.type = 'acquirer'\n    this.icon = () => <UrlIcon />\n\n    // Set default options and locale\n    this.defaultLocale = locale\n\n    this.i18nInit()\n\n    this.hostname = this.opts.companionUrl\n\n    if (!this.hostname) {\n      throw new Error(\n        'Companion hostname is required, please consult https://uppy.io/docs/companion',\n      )\n    }\n\n    this.client = new RequestClient(uppy, {\n      pluginId: this.id,\n      provider: 'url',\n      companionUrl: this.opts.companionUrl,\n      companionHeaders: this.opts.companionHeaders,\n      companionCookiesRule: this.opts.companionCookiesRule,\n    })\n\n    this.uppy.registerRequestClient(Url.requestClientId, this.client)\n  }\n\n  private getMeta = (url: string): Promise<MetaResponse> => {\n    return this.client.post<MetaResponse>('url/meta', { url }).then((res) => {\n      // TODO: remove this handler in the next major\n      if ((res as any).error) {\n        this.uppy.log('[URL] Error:')\n        this.uppy.log((res as any).error)\n        throw new Error('Failed to fetch the file')\n      }\n      return res\n    })\n  }\n\n  private addFile = async (\n    protocollessUrl: string,\n    optionalMeta?: M,\n  ): Promise<string | undefined> => {\n    const url = addProtocolToURL(protocollessUrl)\n    if (!checkIfCorrectURL(url)) {\n      this.uppy.log(`[URL] Incorrect URL entered: ${url}`)\n      this.uppy.info(this.i18n('enterCorrectUrl'), 'error', 4000)\n      return undefined\n    }\n\n    try {\n      const meta = await this.getMeta(url)\n\n      const tagFile: TagFile<M> = {\n        meta: optionalMeta,\n        source: this.id,\n        name: meta.name || getFileNameFromUrl(url),\n        type: meta.type,\n        data: {\n          size: meta.size,\n        },\n        isRemote: true,\n        body: {\n          url,\n        },\n        remote: {\n          companionUrl: this.opts.companionUrl,\n          url: `${this.hostname}/url/get`,\n          body: {\n            fileId: url,\n            url,\n          },\n          requestClientId: Url.requestClientId,\n        },\n      }\n\n      this.uppy.log('[Url] Adding remote file')\n      try {\n        return this.uppy.addFile(tagFile)\n      } catch (err) {\n        if (!err.isRestriction) {\n          this.uppy.log(err)\n        }\n        return err\n      }\n    } catch (err) {\n      this.uppy.log(err)\n      this.uppy.info(\n        {\n          message: this.i18n('failedToFetch'),\n          details: err,\n        },\n        'error',\n        4000,\n      )\n      return err\n    }\n  }\n\n  private handleRootDrop = (e: DragEvent) => {\n    forEachDroppedOrPastedUrl(e.dataTransfer!, 'drop', (url) => {\n      this.uppy.log(`[URL] Adding file from dropped url: ${url}`)\n      this.addFile(url)\n    })\n  }\n\n  private handleRootPaste = (e: ClipboardEvent) => {\n    forEachDroppedOrPastedUrl(e.clipboardData!, 'paste', (url) => {\n      this.uppy.log(`[URL] Adding file from pasted url: ${url}`)\n      this.addFile(url)\n    })\n  }\n\n  render(): ComponentChild {\n    return <UrlUI i18n={this.i18n} addFile={this.addFile} />\n  }\n\n  install(): void {\n    const { target } = this.opts\n    if (target) {\n      this.mount(target, this)\n    }\n  }\n\n  uninstall(): void {\n    this.unmount()\n  }\n}\n\n// This is defined outside of the class body because it's not using `this`, but\n// we still want it available on the prototype so the Dashboard can access it.\nUrl.prototype.canHandleRootDrop = canHandleRootDrop\n"],"mappings":"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"}