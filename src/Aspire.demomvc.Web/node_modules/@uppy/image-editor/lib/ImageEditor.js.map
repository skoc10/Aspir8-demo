{"version":3,"names":["UIPlugin","h","Editor","packageJson","locale","defaultCropperOptions","viewMode","background","autoCropArea","responsive","minCropBoxWidth","minCropBoxHeight","croppedCanvasOptions","initialAspectRatio","defaultActions","revert","rotate","granularRotate","flip","zoomIn","zoomOut","cropSquare","cropWidescreen","cropWidescreenVertical","defaultOptions","quality","actions","cropperOptions","ImageEditor","constructor","uppy","opts","save","saveBlobCallback","blob","currentImage","getPluginState","setFileState","id","data","File","name","type","size","preview","undefined","updatedFile","getFile","emit","setPluginState","croppedCanvas","cropper","getCroppedCanvas","width","setData","height","toBlob","storeCropperInstance","selectFile","file","title","defaultLocale","i18nInit","canEditFile","isRemote","fileTypeSpecific","split","test","install","target","mount","uninstall","unmount","render","i18n","VERSION","version"],"sources":["ImageEditor.tsx"],"sourcesContent":["import { UIPlugin, type UIPluginOptions, type Uppy } from '@uppy/core'\nimport type { DefinePluginOpts } from '@uppy/core/lib/BasePlugin.js'\nimport type Cropper from 'cropperjs'\nimport { h } from 'preact'\n\nimport type { Meta, Body, UppyFile } from '@uppy/utils/lib/UppyFile'\nimport Editor from './Editor.tsx'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore We don't want TS to generate types for the package.json\nimport packageJson from '../package.json'\nimport locale from './locale.ts'\n\ndeclare global {\n  namespace preact {\n    interface Component {\n      // This is a workaround for https://github.com/preactjs/preact/issues/1206\n      refs: Record<string, any>\n    }\n  }\n}\n\ntype ThumbnailGeneratedCallback<M extends Meta, B extends Body> = (\n  file: UppyFile<M, B>,\n  preview: string,\n) => void\ntype GenericCallback<M extends Meta, B extends Body> = (\n  file: UppyFile<M, B>,\n) => void\ndeclare module '@uppy/core' {\n  export interface UppyEventMap<M extends Meta, B extends Body> {\n    'thumbnail:request': GenericCallback<M, B>\n    'thumbnail:generated': ThumbnailGeneratedCallback<M, B>\n    'file-editor:complete': GenericCallback<M, B>\n    'file-editor:start': GenericCallback<M, B>\n    'file-editor:cancel': GenericCallback<M, B>\n  }\n}\n\ninterface Opts extends UIPluginOptions {\n  quality?: number\n  cropperOptions?: Cropper.Options & {\n    croppedCanvasOptions?: Cropper.GetCroppedCanvasOptions\n  }\n  actions?: {\n    revert?: boolean\n    rotate?: boolean\n    granularRotate?: boolean\n    flip?: boolean\n    zoomIn?: boolean\n    zoomOut?: boolean\n    cropSquare?: boolean\n    cropWidescreen?: boolean\n    cropWidescreenVertical?: boolean\n  }\n}\nexport type { Opts as ImageEditorOptions }\n\ntype PluginState<M extends Meta, B extends Body> = {\n  currentImage: UppyFile<M, B> | null\n}\n\nconst defaultCropperOptions = {\n  viewMode: 0 as const,\n  background: false,\n  autoCropArea: 1,\n  responsive: true,\n  minCropBoxWidth: 70,\n  minCropBoxHeight: 70,\n  croppedCanvasOptions: {},\n  initialAspectRatio: 0,\n} satisfies Partial<Opts['cropperOptions']>\n\nconst defaultActions = {\n  revert: true,\n  rotate: true,\n  granularRotate: true,\n  flip: true,\n  zoomIn: true,\n  zoomOut: true,\n  cropSquare: true,\n  cropWidescreen: true,\n  cropWidescreenVertical: true,\n} satisfies Partial<Opts['actions']>\n\nconst defaultOptions = {\n  // `quality: 1` increases the image size by orders of magnitude - 0.8 seems to be the sweet spot.\n  // see https://github.com/fengyuanchen/cropperjs/issues/538#issuecomment-1776279427\n  quality: 0.8,\n  actions: defaultActions,\n  cropperOptions: defaultCropperOptions,\n} satisfies Partial<Opts>\n\ntype InternalImageEditorOpts = Omit<\n  DefinePluginOpts<Opts, keyof typeof defaultOptions>,\n  'actions' | 'cropperOptions'\n> & {\n  actions: DefinePluginOpts<\n    NonNullable<Opts['actions']>,\n    keyof typeof defaultActions\n  >\n  cropperOptions: DefinePluginOpts<\n    NonNullable<Opts['cropperOptions']>,\n    keyof typeof defaultCropperOptions\n  >\n}\n\nexport default class ImageEditor<\n  M extends Meta,\n  B extends Body,\n> extends UIPlugin<InternalImageEditorOpts, M, B, PluginState<M, B>> {\n  static VERSION = packageJson.version\n\n  cropper: Cropper\n\n  constructor(uppy: Uppy<M, B>, opts?: Opts) {\n    super(uppy, {\n      ...defaultOptions,\n      ...opts,\n      actions: {\n        ...defaultActions,\n        ...opts?.actions,\n      },\n      cropperOptions: {\n        ...defaultCropperOptions,\n        ...opts?.cropperOptions,\n      },\n    })\n    this.id = this.opts.id || 'ImageEditor'\n    this.title = 'Image Editor'\n    this.type = 'editor'\n\n    this.defaultLocale = locale\n\n    this.i18nInit()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  canEditFile(file: UppyFile<M, B>): boolean {\n    if (!file.type || file.isRemote) {\n      return false\n    }\n\n    const fileTypeSpecific = file.type.split('/')[1]\n\n    if (/^(jpe?g|gif|png|bmp|webp)$/.test(fileTypeSpecific)) {\n      return true\n    }\n\n    return false\n  }\n\n  save = (): void => {\n    const saveBlobCallback: BlobCallback = (blob) => {\n      const { currentImage } = this.getPluginState()\n\n      this.uppy.setFileState(currentImage!.id, {\n        // Reinserting image's name and type, because .toBlob loses both.\n        data: new File([blob!], currentImage!.name, { type: blob!.type }),\n        size: blob!.size,\n        preview: undefined,\n      })\n\n      const updatedFile = this.uppy.getFile(currentImage!.id)\n      this.uppy.emit('thumbnail:request', updatedFile)\n      this.setPluginState({\n        currentImage: updatedFile,\n      })\n      this.uppy.emit('file-editor:complete', updatedFile)\n    }\n\n    const { currentImage } = this.getPluginState()\n\n    // Fixes black 1px lines on odd-width images.\n    // This should be removed when cropperjs fixes this issue.\n    // (See https://github.com/transloadit/uppy/issues/4305 and https://github.com/fengyuanchen/cropperjs/issues/551).\n    const croppedCanvas = this.cropper.getCroppedCanvas({})\n    if (croppedCanvas.width % 2 !== 0) {\n      this.cropper.setData({ width: croppedCanvas.width - 1 })\n    }\n    if (croppedCanvas.height % 2 !== 0) {\n      this.cropper.setData({ height: croppedCanvas.height - 1 })\n    }\n\n    this.cropper\n      .getCroppedCanvas(this.opts.cropperOptions.croppedCanvasOptions)\n      .toBlob(saveBlobCallback, currentImage!.type, this.opts.quality)\n  }\n\n  storeCropperInstance = (cropper: Cropper): void => {\n    this.cropper = cropper\n  }\n\n  selectFile = (file: UppyFile<M, B>): void => {\n    this.uppy.emit('file-editor:start', file)\n    this.setPluginState({\n      currentImage: file,\n    })\n  }\n\n  install(): void {\n    this.setPluginState({\n      currentImage: null,\n    })\n\n    const { target } = this.opts\n    if (target) {\n      this.mount(target, this)\n    }\n  }\n\n  uninstall(): void {\n    const { currentImage } = this.getPluginState()\n\n    if (currentImage) {\n      const file = this.uppy.getFile(currentImage.id)\n      this.uppy.emit('file-editor:cancel', file)\n    }\n    this.unmount()\n  }\n\n  render() {\n    const { currentImage } = this.getPluginState()\n\n    if (currentImage === null || currentImage.isRemote) {\n      return null\n    }\n\n    return (\n      <Editor<M, B>\n        currentImage={currentImage}\n        storeCropperInstance={this.storeCropperInstance}\n        save={this.save}\n        opts={this.opts}\n        i18n={this.i18n}\n      />\n    )\n  }\n}\n"],"mappings":"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"}